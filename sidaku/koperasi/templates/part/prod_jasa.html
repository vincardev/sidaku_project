
{% load widget_tweaks %}
<div class="card p-3 mb-2 rounded-0 rounded-bottom" >
    <h3 class="text-center"> Produk Jasa </h3>
    <div class="card-body row ">
        <div class="col-lg-12  col-sm-12 mb-2 form-group">
            <div class="row">

                <div class="col-lg-12  col-sm-12 text-left py-6 mt-2">
                    <label>Produk <button type="button" id="modalprod" class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#addprod" data-bs-whatever="Jenis Produk">+</button></label>
                    <textarea name="jenprod" id="jenprod"  hidden="hidden"></textarea>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th >Foto</th>
                                <th >Komoditi</th>
                                <th >Volume</th>
                                <th >Satuan</th>
                                <th >Harga</th>
                                <th >Total</th>
                                <th ></th>
                            </tr>
                        </thead>
                        <tbody class="tb-fill">
                            <tr>
                                <td colspan="6" class="text-center">no item</td>
                            </tr> 
                        </tbody>
                    </table>

                </div>


                <div class="col-lg-6  col-sm-12 text-left py-6">
                    <label>{{ form.pj_jassimkop.label }} 
                        {% if form.instance.pj_jassimkop %}
                        <span class="text-xs font-weight-bold">
                            <a class="btn btn-sm btn-success" type="button" data-bs-toggle="tooltip" data-bs-title="Download File"  href="{{form.instance.pj_jassimkop.url}}" download>
                                <i class="bi bi-download"></i>
                            </a> 
                        </span> 
                        {% endif %}
                    </label>
                    {% if form.is_bound %}
                    {% if form.pj_jassimkop.errors %}
                    {% render_field form.pj_jassimkop class="form-control is-invalid" %}
                    {% else %}
                    {% render_field form.pj_jassimkop class="form-control is-valid" %}
                    {% endif %}
                    {% else %}
                    {% render_field form.pj_jassimkop class="form-control" %}
                    {% endif %}
                    {% for error in form.pj_jassimkop.errors %}
                    <div class="invalid-feedback">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="col-lg-6  col-sm-12 text-left py-6">
                    <label>{{ form.pj_jaspinkop.label }}</label>
                    {% if form.instance.pj_jaspinkop %}
                    <span class="text-xs font-weight-bold">
                        <a class="btn btn-sm btn-success" type="button" data-bs-toggle="tooltip" data-bs-title="Download File"  href="{{form.instance.pj_jaspinkop.url}}" download>
                            <i class="bi bi-download"></i>
                        </a> 
                    </span> 
                    {% endif %}
                    {% if form.is_bound %}
                        {% if form.pj_jaspinkop.errors %}
                            {% render_field form.pj_jaspinkop class="form-control is-invalid" rows="8" %}
                        {% else %}
                            {% render_field form.pj_jaspinkop class="form-control is-valid" rows="8" %}
                        {% endif %}
                    {% else %}
                        {% render_field form.pj_jaspinkop class="form-control" rows="8" %}
                    {% endif %}
                    {% for error in form.pj_jaspinkop.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                    {% endfor %}
                </div>
                
                
                
                <div class="col-lg-12  col-sm-12 text-left py-6">
                    <label>{{ form.pj_produngkop.label }}</label>
                    {% if form.instance.pj_produngkop %}
                    <span class="text-xs font-weight-bold">
                        <a class="btn btn-sm btn-success" type="button" data-bs-toggle="tooltip" data-bs-title="Download File"  href="{{form.instance.pj_produngkop.url}}" download>
                            <i class="bi bi-download"></i>
                        </a> 
                    </span> 
                    {% endif %}
                    {% if form.is_bound %}
                        {% if form.pj_produngkop.errors %}
                            {% render_field form.pj_produngkop class="form-control is-invalid" %}
                        {% else %}
                            {% render_field form.pj_produngkop class="form-control is-valid" %}
                        {% endif %}
                    {% else %}
                        {% render_field form.pj_produngkop class="form-control" %}
                    {% endif %}
                    {% for error in form.pj_produngkop.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                    {% endfor %}
                </div>

                
            </div>

        </div>
    </div>

</div>


<div class="modal fade" id="addprod" tabindex="-1" aria-labelledby="addprodlLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="addprodlLabel">Tambah Jenis Produk</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
              <label for="foto-name" class="col-form-label">Foto Produk</label>
              <input accept="image/*" class="form-control form-control-sm" id="fotoprod" type="file">
            </div>
            <div class="mb-3">
              <label for="komoditi-name" class="col-form-label">Komoditi</label>
              <input type="hidden" class="form-control form-control-sm" id="idxinput">
              <input type="text" class="form-control form-control-sm" id="komoditiprod">
            </div>
            <div class="mb-3">
              <label for="volume-text" class="col-form-label">Volume</label>
              <input type="number" class="form-control form-control-sm" id="volumeprod">
            </div>
            <div class="mb-3">
              <label for="satuan-text" class="col-form-label">Satuan</label>
              <input type="text" class="form-control form-control-sm" id="satuanprod">
            </div>
            <div class="mb-3">
              <label for="harga-text" class="col-form-label">Harga</label>
              <input type="number" class="form-control form-control-sm" id="hargaprod">
            </div>
            <div class="mb-3">
              <label for="total-text" class="col-form-label">Total</label>
              <input type="number" class="form-control form-control-sm" id="totalprod">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="btntambah">Tambah</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="btnedit" onclick="EditData()">Edit</button>
        </div>
      </div>
    </div>
</div>

{% block javascripts %}
<script>

btntambah   = document.getElementById("btntambah")
btnedit     = document.getElementById("btnedit")
modalprod   = document.getElementById("modalprod")

var strjson = []

modalprod.addEventListener("click", function(){

    fotoprod = document.getElementById("fotoprod")
    komoditiprod = document.getElementById("komoditiprod")
    volumeprod = document.getElementById("volumeprod")
    satuanprod = document.getElementById("satuanprod")
    hargaprod = document.getElementById("hargaprod")
    totalprod = document.getElementById("totalprod")

    fotoprod.value = "";
    komoditiprod.value = "";
    volumeprod.value = "";
    satuanprod.value = "";
    hargaprod.value = "";
    totalprod.value = "";

    $("#btnedit").hide();
    $("#btntambah").show();
});

btntambah.addEventListener("click", function(){

    fotoprod = document.getElementById("fotoprod")
    komoditiprod = document.getElementById("komoditiprod")
    volumeprod = document.getElementById("volumeprod")
    satuanprod = document.getElementById("satuanprod")
    hargaprod = document.getElementById("hargaprod")
    totalprod = document.getElementById("totalprod")
    

    data = {
        "id":"",
        "foto":fotoprod.value,
        "komoditi":komoditiprod.value,
        "volume":volumeprod.value,
        "satuan":satuanprod.value,
        "harga":hargaprod.value,
        "total":totalprod.value,
        "url":"",
    }
    //convert JavaScript object to JSON
   
    strjson.push(data);
    ConvertToTable((strjson.length-1),true);
    readURL($("#fotoprod")[0].files, ".imgprod-"+(strjson.length-1));
    
    inputfile = $("#fotoprod")[0].files;    
    if (inputfile.length != 0){
        $("input[name='fotoprod-"+(strjson.length-1)+"']")[0].files= inputfile;
    }
    
    $("#jenprod").text(JSON.stringify(strjson));
    //jsonText.innerText = JSON.stringify(data)
});


function DeleteTable(index){
    $(".trindex-"+index).remove();
    for (let i = index; i < strjson.length; i++) {
        $(".trindex-"+i).removeClass('trindex-'+i).addClass('trindex-'+(i-1));
        $(".imgprod-"+i).removeClass('imgprod-'+i).addClass('imgprod-'+(i-1));
        $("#fotoprod-"+i).attr('id', "fotoprod-"+(i-1));
        $("#komoditi-"+i).attr('id', "komoditi-"+(i-1));
        $("#volume-"+i).attr('id', "volume-"+(i-1));
        $("#satuan-"+i).attr('id', "satuan-"+(i-1));
        $("#harga-"+i).attr('id', "harga-"+(i-1));
        $("#total-"+i).attr('id', "total-"+(i-1));
        $("#actionbtn-"+i).attr('id', "actionbtn-"+(i-1));

        $("input[name='fotoprod-"+i+"']").attr('name', "fotoprod-"+(i-1));
        $("input[name='komoditi-"+i+"']").attr('name', "komoditi-"+(i-1));
        $("input[name='volume-"+i+"']").attr('name', "volume-"+(i-1));
        $("input[name='satuan-"+i+"']").attr('name', "satuan-"+(i-1));
        $("input[name='harga-"+i+"']").attr('name', "harga-"+(i-1));
        $("input[name='total-"+i+"']").attr('name', "total-"+(i-1));

        html = "<button type='button' class='btn btn-sm btn-warning'  data-bs-toggle='modal' data-bs-target='#addprod' data-bs-whatever='Jenis Produk'  onclick='EditTable("+(i-1)+")'><i class='bi bi-pencil-square'></i></button> <button type='button' onclick='DeleteTable("+(i-1)+")' class='btn btn-sm btn-danger'><i class='bi bi-eraser-fill'></i></button>";
        $("#actionbtn-"+(i-1)).html(html)
        // console.log(i);
    }
    strjson.splice(index,1);
    $("#jenprod").text(JSON.stringify(strjson));
}


function EditTable(index){

    fotoprod = document.getElementById("fotoprod")
    komoditiprod = document.getElementById("komoditiprod")
    volumeprod = document.getElementById("volumeprod")
    satuanprod = document.getElementById("satuanprod")
    hargaprod = document.getElementById("hargaprod")
    totalprod = document.getElementById("totalprod")
    idxinput = document.getElementById("idxinput")
    
    inputfile = $("input[name='fotoprod-"+index+"']")[0].files;
     
    $("#fotoprod")[0].files =inputfile;

    //fotoprod.src      = strjson[index].foto;
    komoditiprod.value  = strjson[index].komoditi;
    volumeprod.value    = strjson[index].volume;
    satuanprod.value    = strjson[index].satuan;
    hargaprod.value     = strjson[index].harga;
    totalprod.value     = strjson[index].total;

    idxinput.value = index;

    $("#btnedit").show();
    $("#btntambah").hide();
}


function EditData(){

    fotoprod = document.getElementById("fotoprod")
    komoditiprod = document.getElementById("komoditiprod")
    volumeprod = document.getElementById("volumeprod")
    satuanprod = document.getElementById("satuanprod")
    hargaprod = document.getElementById("hargaprod")
    totalprod = document.getElementById("totalprod")
    idxinput = document.getElementById("idxinput")
    
    index = idxinput.value 
    readURL($("#fotoprod")[0].files, ".imgprod-"+index);


    strjson[index].foto = '';
    strjson[index].komoditi = komoditiprod.value ;
    strjson[index].volume = volumeprod.value  ;
    strjson[index].satuan = satuanprod.value  ;
    strjson[index].harga = hargaprod.value    ;
    strjson[index].total = totalprod.value    ;
    strjson[index].url = strjson[index].url   ;

    ConvertToTable(index);

    inputfile = $("#fotoprod")[0].files;
    
    if (inputfile.length != 0)
        $("input[name='fotoprod-"+index+"']")[0].files= inputfile;
    
    $("#jenprod").text(JSON.stringify(strjson));
}

function ConvertToTable(trindex = null,newpage = false){
    html ="";
    if (trindex == null){
        for (let i = 0; i < strjson.length; i++) {

            html += "<tr class='trindex-"+i+"'>";
            html +=   "<td id='fotoprod-"+i+"'>"+"<img class='img img-responsive imgprod-"+i+"' src='"+strjson[i].url+"' width='100' height='100'>"+"<input type='file' name='fotoprod-"+i+"' accept='image/png, image/jpeg, image/jpg' style='display:block' >"+"</td>";
            html +=   "<td id='komoditi-"+i+"'>"+ strjson[i].komoditi+  "<input type='hidden'  name='komoditi-"+i+"' value='"+strjson[i].komoditi+"' />" +"</td>";
            html +=   "<td id='volume-"+i+"'>"+ strjson[i].volume+ "<input type='hidden'  name='volume-"+i+"' value='"+strjson[i].volume+"' />"+"</td>";
            html +=   "<td id='satuan-"+i+"'>"+ strjson[i].satuan+ "<input type='hidden'  name='satuan-"+i+"' value='"+strjson[i].satuan+"' />"+"</td>";
            html +=   "<td id='harga-"+i+"'>"+ strjson[i].harga+ "<input type='hidden'  name='harga-"+i+"' value='"+strjson[i].harga+"' />"+"</td>";
            html +=   "<td id='total-"+i+"'>"+ strjson[i].total+ "<input type='hidden'  name='total-"+i+"' value='"+strjson[i].total+"' />"+"</td>";
            html +=   "<td id='actionbtn-"+i+"'><button type='button' class='btn btn-sm btn-warning'  data-bs-toggle='modal' data-bs-target='#addprod' data-bs-whatever='Jenis Produk'  onclick='EditTable("+i+")'><i class='bi bi-pencil-square'></i></button> <button type='button' onclick='DeleteTable("+i+")' class='btn btn-sm btn-danger'><i class='bi bi-eraser-fill'></i></button></td>";
            html += "<tr>"; 
        }
        
        $(".tb-fill").html(html);
    }
    else {
        var i = trindex;

        html +=   "<td id='fotoprod-"+i+"'>"+"<img class='img img-responsive imgprod-"+i+"' src='"+strjson[i].url+"'  width='100' height='100'>"+ "<input type='file' name='fotoprod-"+i+"' accept='image/png, image/jpeg, image/jpg' style='display:block' >"+"</td>";
        html +=   "<td id='komoditi-"+i+"'>"+ strjson[i].komoditi+  "<input type='hidden'  name='komoditi-"+i+"' value='"+strjson[i].komoditi+"' />" +"</td>";
        html +=   "<td id='volume-"+i+"'>"+ strjson[i].volume+ "<input type='hidden'  name='volume-"+i+"' value='"+strjson[i].volume+"' />"+"</td>";
        html +=   "<td id='satuan-"+i+"'>"+ strjson[i].satuan+ "<input type='hidden'  name='satuan-"+i+"' value='"+strjson[i].satuan+"' />"+"</td>";
        html +=   "<td id='harga-"+i+"'>"+ strjson[i].harga+ "<input type='hidden'  name='harga-"+i+"' value='"+strjson[i].harga+"' />"+"</td>";
        html +=   "<td id='total-"+i+"'>"+ strjson[i].total+ "<input type='hidden'  name='total-"+i+"' value='"+strjson[i].total+"' />"+"</td>";
        html +=   "<td id='actionbtn-"+i+"'><button type='button' class='btn btn-sm btn-warning'  data-bs-toggle='modal' data-bs-target='#addprod' data-bs-whatever='Jenis Produk'  onclick='EditTable("+i+")'><i class='bi bi-pencil-square'></i></button> <button type='button' onclick='DeleteTable("+i+")' class='btn btn-sm btn-danger'><i class='bi bi-eraser-fill'></i></button></td>";
       
        if (newpage == true){
            tag =  "<tr class='trindex-"+i+"'></tr>";
            $(".tb-fill").append(tag)
            $(".trindex-"+trindex).html(html);
        } else{
            $(".trindex-"+trindex).html(html);
        }

    }
}


function readURL(input, classstring) {
    // if (input.files && input.files[0]) {
    if (input.length != 0) {
        var reader = new FileReader();
        
        reader.onload = function (e) {
            $(classstring).attr('src', e.target.result);
            return e.target.result;
        }
        
        reader.readAsDataURL(input[0]);
    }
}
</script>



{% endblock %}